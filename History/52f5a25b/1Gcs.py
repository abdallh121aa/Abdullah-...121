# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See LICENSE in the project root
# for license information.

from __future__ import absolute_import, division, print_function, unicode_literals

__all__ = ["main"]

import locale
import os
import signal
import sys

# WARNING: debugpy and submodules must not be imported on top level in this module,
# and should be imported locally inside main() instead.

# Force absolute path on Python 2.
__file__ = os.path.abspath(__file__)


def main():
    from debugpy import launcher
    from debugpy.common import log
    from debugpy.launcher import debuggee

    log.to_file(prefix="debugpy.launcher")
    log.describe_environment("debugpy.launcher startup environment:")

    if sys.platform == "win32":
        # For windows, disable exceptions on Ctrl+C - we want to allow the debuggee
        # process to handle these, or not, as it sees fit. If the debuggee exits
        # on Ctrl+C, the launcher will also exit, so it doesn't need to observe
        # the signal directly.
        signal.signal(signal.SIGINT, signal.SIG_IGN)

    # Everything before "--" is command line arguments for the launcher itself,
    # and everything after "--" is command line arguments for the debuggee.
    log.info("sys.argv before parsing: {0}", sys.argv)
    sep = sys.argv.index("--")
    launcher_argv = sys.argv[1:sep]
    sys.argv[:] = [sys.argv[0]] + sys.argv[sep + 1 :]
    log.info("sys.argv after patching: {0}", sys.argv)

    # The first argument specifies the host/port on which the adapter is waiting
    # for launcher to connect. It's either host:port, or just port.
    adapter = launcher_argv[0]
    host, sep, port = adapter.partition(":")
    if not sep:
        host = "127.0.0.1"
        port = adapter
    port = int(port)

    launcher.connect(host, port)
    launcher.channel.wait()

    if debuggee.process is not None:
        sys.exit(debuggee.process.returncode)


if __name__ == "__main__":
    # debugpy can also be invoked directly rather than via -m. In this case, the first
    # entry on sys.path is the one added automatically by Python for the directory
    # containing this file. This means that import debugpy will not work, since we need
    # the parent directory of debugpy/ to be in sys.path, rather than debugpy/launcher/.
    #
    # The other issue is that many other absolute imports will break, because they
    # will be resolved relative to debugpy/launcher/ - e.g. `import state` will then try
    # to import debugpy/launcher/state.py.
    #
    # To fix both, we need to replace the automatically added entry such that it points
    # at parent directory of debugpy/ instead of debugpy/launcher, import debugpy with that
    # in sys.path, and then remove the first entry entry altogether, so that it doesn't
    # affect any further imports we might do. For example, suppose the user did:
    #
    #   python /foo/bar/debugpy/launcher ...
    #
    # At the beginning of this script, sys.path will contain "/foo/bar/debugpy/launcher"
    # as the first entry. What we want is to replace it with "/foo/bar', then import
    # debugpy with that in effect, and then remove the replaced entry before any more
    # code runs. The imported debugpy module will remain in sys.modules, and thus all
    # future imports of it or its submodules will resolve accordingly.
    if "debugpy" not in sys.modules:
        # Do not use dirname() to walk up - this can be a relative path, e.g. ".".
        sys.path[0] = sys.path[0] + "/../../"
        __import__("debugpy")
        del sys.path[0]

    # Apply OS-global and user-specific locale settings.
    try:
        locale.setlocale(locale.LC_ALL, "")
    except Exception:
        # On POSIX, locale is set via environment variables, and this can fail if
        # those variables reference a non-existing locale. Ignore and continue using
        # the default "C" locale if so.
        pass

    main(#&#1575;&#1604;&#1581;&#1576; &#1585;&#1575;&#1576;&#1591; &#1576;&#1610;&#1606; &#1591;&#1585;&#1601;&#1610;&#1606; &#1610;&#1606;&#1588;&#1571; &#1604;&#1571;&#1587;&#1576;&#1575;&#1576; &#1604;&#1575; &#1610;&#1605;&#1603;&#1606; &#1578;&#1601;&#1587;&#1610;&#1585;&#1607;&#1575; &#1601;&#1610; &#1603;&#1579;&#1610;&#1585; &#1605;&#1606; &#1575;&#1604;&#1571;&#1581;&#1610;&#1575;&#1606;&#1548; &#1607;&#1608; &#1588;&#1610;&#1569; &#1604;&#1575; &#1610;&#1605;&#1603;&#1606; &#1575;&#1604;&#1578;&#1606;&#1576;&#1572; &#1576;&#1607;&#1548; &#1608;&#1604;&#1603;&#1606; &#1575;&#1604;&#1603;&#1604; &#1610;&#1572;&#1605;&#1606; &#1576;&#1607; &#1608;&#1610;&#1593;&#1585;&#1601;&#1607;&#1548; &#1576;&#1604; &#1608;&#1610;&#1589;&#1601;&#1607; &#1603;&#1604; &#1593;&#1575;&#1588;&#1602; &#1576;&#1589;&#1608;&#1585;&#1577; &#1605;&#1582;&#1578;&#1604;&#1601;&#1577;&#1548; &#1607;&#1606;&#1575;&#1603; &#1605;&#1606; &#1585;&#1587;&#1605; &#1575;&#1604;&#1581;&#1576; &#1601;&#1610; &#1604;&#1608;&#1581;&#1577; &#1601;&#1606;&#1610;&#1577;&#1548; &#1608;&#1607;&#1606;&#1575;&#1603; &#1605;&#1606; &#1603;&#1578;&#1576;&#1607; &#1601;&#1610; &#1602;&#1589;&#1610;&#1583;&#1577;&#1548; &#1608;&#1607;&#1606;&#1575;&#1603; &#1605;&#1606; &#1593;&#1586;&#1601;&#1607; &#1608;&#1578;&#1585;&#1575;&#1611; &#1608;&#1578;&#1594;&#1606;&#1609; &#1576;&#1607;.
#&#1601;&#1610; &#1593;&#1575;&#1604;&#1605; &#1575;&#1604;&#1593;&#1588;&#1602; &#1604;&#1575; &#1610;&#1588;&#1578;&#1585;&#1591; &#1571;&#1606; &#1610;&#1603;&#1608;&#1606; &#1575;&#1604;&#1591;&#1585;&#1601;&#1575;&#1606; &#1605;&#1606; &#1575;&#1604;&#1576;&#1588;&#1585;&#1548; &#1576;&#1604; &#1573;&#1606; &#1605;&#1593;&#1606;&#1609; &#1575;&#1604;&#1581;&#1576; &#1610;&#1605;&#1578;&#1583; &#1604;&#1610;&#1603;&#1608;&#1606; &#1585;&#1575;&#1576;&#1591;&#1575;&#1611; &#1576;&#1610;&#1606; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1608;&#1588;&#1610;&#1569; &#1605;&#1606; &#1575;&#1604;&#1603;&#1575;&#1574;&#1606;&#1575;&#1578; &#1571;&#1608; &#1581;&#1578;&#1609; &#1575;&#1604;&#1580;&#1605;&#1575;&#1583;&#1575;&#1578;&#1548; &#1601;&#1571;&#1606; &#1610;&#1593;&#1588;&#1602; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1588;&#1610;&#1574;&#1575;&#1611; &#1605;&#1606; &#1575;&#1604;&#1580;&#1605;&#1575;&#1583;&#1575;&#1578; &#1610;&#1593;&#1583; &#1605;&#1606; &#1575;&#1604;&#1571;&#1605;&#1608;&#1585; &#1575;&#1604;&#1605;&#1571;&#1604;&#1608;&#1601;&#1577;&#1548; &#1603;&#1571;&#1606; &#1610;&#1581;&#1576; &#1584;&#1604;&#1603; &#1575;&#1604;&#1602;&#1604;&#1605; &#1575;&#1604;&#1584;&#1610; &#1575;&#1588;&#1578;&#1585;&#1575;&#1607; &#1581;&#1610;&#1606; &#1603;&#1575;&#1606; &#1589;&#1594;&#1610;&#1585;&#1575;&#1611;&#1548; &#1571;&#1608; &#1571;&#1606; &#1610;&#1581;&#1576; &#1584;&#1604;&#1603; &#1575;&#1604;&#1603;&#1585;&#1587;&#1610; &#1601;&#1610; &#1581;&#1583;&#1610;&#1602;&#1577; &#1605;&#1606;&#1586;&#1604;&#1607; &#1601;&#1578;&#1580;&#1583;&#1607; &#1610;&#1602;&#1590;&#1610; &#1593;&#1604;&#1610;&#1607; &#1603;&#1604; &#1610;&#1608;&#1605; &#1580;&#1586;&#1569;&#1611;&#1575; &#1605;&#1606; &#1608;&#1602;&#1578;&#1607;&#1548; &#1571;&#1608; &#1571;&#1606; &#1610;&#1581;&#1576; &#1575;&#1604;&#1602;&#1585;&#1575;&#1569;&#1577; &#1601;&#1610; &#1605;&#1603;&#1575;&#1606;&#1607; &#1575;&#1604;&#1605;&#1601;&#1590;&#1604; &#1593;&#1604;&#1609; &#1590;&#1601;&#1577; &#1575;&#1604;&#1606;&#1607;&#1585;. &#1603;&#1604; &#1584;&#1604;&#1603; &#1610;&#1593;&#1583; &#1605;&#1606; &#1571;&#1606;&#1608;&#1575;&#1593; &#1575;&#1604;&#1581;&#1576; &#1575;&#1604;&#1578;&#1610; &#1606;&#1604;&#1575;&#1581;&#1592;&#1607;&#1575; &#1576;&#1575;&#1587;&#1578;&#1605;&#1585;&#1575;&#1585;&#1548; &#1576;&#1604; &#1608;&#1578;&#1593;&#1583; &#1607;&#1584;&#1607; &#1575;&#1604;&#1571;&#1606;&#1608;&#1575;&#1593; &#1605;&#1606; &#1575;&#1604;&#1593;&#1588;&#1602; &#1605;&#1606; &#1575;&#1604;&#1571;&#1588;&#1610;&#1575;&#1569; &#1575;&#1604;&#1580;&#1605;&#1610;&#1604;&#1577; &#1575;&#1604;&#1578;&#1610; &#1578;&#1605;&#1610;&#1586; &#1588;&#1582;&#1589;&#1610;&#1575;&#1578; &#1575;&#1604;&#1576;&#1588;&#1585; &#1605;&#1606; &#1581;&#1608;&#1604;&#1606;&#1575;
#&#1575;&#1604;&#1575;&#1582;&#1578;&#1585;&#1575;&#1593;&#1575;&#1578; &#1608;&#1575;&#1604;&#1578;&#1591;&#1608;&#1585; &#1608;&#1575;&#1604;&#1589;&#1606;&#1575;&#1593;&#1577; &#1608;&#1575;&#1604;&#1578;&#1602;&#1606;&#1610;&#1577; &#1578;&#1572;&#1579;&#1585; &#1601;&#1610; &#1579;&#1602;&#1575;&#1601;&#1575;&#1578; &#1575;&#1604;&#1576;&#1588;&#1585;&#1548; &#1607;&#1584;&#1575; &#1575;&#1604;&#1578;&#1591;&#1608;&#1585; &#1575;&#1604;&#1576;&#1588;&#1585;&#1610; &#1593;&#1606;&#1609; &#1571;&#1606; &#1603;&#1604; &#1586;&#1605;&#1575;&#1606; &#1587;&#1610;&#1578;&#1605;&#1610;&#1586; &#1576;&#1571;&#1588;&#1610;&#1575;&#1569; &#1604;&#1605; &#1578;&#1603;&#1606; &#1605;&#1608;&#1580;&#1608;&#1583;&#1577; &#1601;&#1610; &#1575;&#1604;&#1587;&#1575;&#1576;&#1602;&#1548; &#1608;&#1607;&#1584;&#1575; &#1576;&#1591;&#1576;&#1610;&#1593;&#1577; &#1575;&#1604;&#1581;&#1575;&#1604; &#1610;&#1593;&#1606;&#1610; &#1571;&#1606; &#1605;&#1593; &#1575;&#1604;&#1578;&#1591;&#1608;&#1585; &#1601;&#1573;&#1606;&#1607; &#1605;&#1606; &#1575;&#1604;&#1605;&#1578;&#1608;&#1602;&#1593; &#1571;&#1606; &#1610;&#1581;&#1576; &#1571;&#1608; &#1610;&#1593;&#1588;&#1602; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1571;&#1588;&#1610;&#1575;&#1569;&#1611; &#1604;&#1605; &#1610;&#1593;&#1588;&#1602;&#1607;&#1575; &#1571;&#1587;&#1604;&#1575;&#1601;&#1607;&#1548; &#1604;&#1610;&#1587; &#1604;&#1571;&#1606;&#1607;&#1575; &#1604;&#1605; &#1578;&#1603;&#1606; &#1578;&#1587;&#1578;&#1581;&#1602; &#1575;&#1604;&#1575;&#1607;&#1578;&#1605;&#1575;&#1605;&#1548; &#1608;&#1604;&#1603;&#1606; &#1604;&#1571;&#1606;&#1607;&#1575; &#1604;&#1605; &#1578;&#1603;&#1606; &#1605;&#1608;&#1580;&#1608;&#1583;&#1577; &#1601;&#1610; &#1575;&#1604;&#1587;&#1575;&#1576;&#1602; &#1571;&#1589;&#1604;&#1575;&#1548; &#1603;&#1571;&#1606; &#1610;&#1581;&#1576; &#1573;&#1606;&#1587;&#1575;&#1606; &#1585;&#1608;&#1576;&#1608;&#1578;&#1575;&#1611; &#1605;&#1579;&#1604;&#1575;&#1611;.
#&#1585;&#1576;&#1605;&#1575; &#1578;&#1593;&#1583; &#1575;&#1604;&#1593;&#1604;&#1575;&#1602;&#1577; &#1575;&#1604;&#1593;&#1575;&#1591;&#1601;&#1610;&#1577; &#1576;&#1610;&#1606; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1608;&#1575;&#1604;&#1585;&#1608;&#1576;&#1608;&#1578; &#1590;&#1585;&#1576;&#1575;&#1611; &#1605;&#1606; &#1575;&#1604;&#1582;&#1610;&#1575;&#1604;&#1548; &#1571;&#1608; &#1605;&#1606; &#1575;&#1604;&#1571;&#1588;&#1610;&#1575;&#1569; &#1575;&#1604;&#1578;&#1610; &#1606;&#1602;&#1585;&#1571;&#1607;&#1575; &#1601;&#1610; &#1575;&#1604;&#1585;&#1608;&#1575;&#1610;&#1575;&#1578;&#1548; &#1608;&#1604;&#1603;&#1606; &#1607;&#1584;&#1607; &#1575;&#1604;&#1592;&#1575;&#1607;&#1585;&#1577; &#1608;&#1573;&#1606; &#1603;&#1575;&#1606; &#1575;&#1604;&#1602;&#1604;&#1610;&#1604; &#1610;&#1578;&#1581;&#1583;&#1579; &#1593;&#1606;&#1607;&#1575; &#1576;&#1588;&#1603;&#1604; &#1580;&#1583;&#1617;&#1610;&#1548; &#1573;&#1604;&#1575; &#1571;&#1606; &#1575;&#1604;&#1571;&#1576;&#1581;&#1575;&#1579; &#1575;&#1604;&#1571;&#1603;&#1575;&#1583;&#1610;&#1605;&#1610;&#1577; &#1576;&#1583;&#1571;&#1578; &#1578;&#1604;&#1578;&#1601;&#1578; &#1604;&#1607;&#1575;&#1548; &#1601;&#1602;&#1583; &#1576;&#1583;&#1571;&#1578; &#1575;&#1604;&#1571;&#1576;&#1581;&#1575;&#1579; &#1608;&#1575;&#1604;&#1583;&#1585;&#1575;&#1587;&#1575;&#1578; &#1578;&#1578;&#1591;&#1585;&#1602; &#1604;&#1604;&#1593;&#1604;&#1575;&#1602;&#1577; &#1576;&#1610;&#1606; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1608;&#1575;&#1604;&#1585;&#1608;&#1576;&#1608;&#1578;&#1548; &#1608;&#1607;&#1584;&#1575; &#1605;&#1575; &#1583;&#1593;&#1575; &#1605;&#1585;&#1603;&#1586; &#1575;&#1604;&#1606;&#1588;&#1585; &#1576;&#1580;&#1575;&#1605;&#1593;&#1577; &#1571;&#1603;&#1587;&#1601;&#1608;&#1585;&#1583; (University of Oxford) &#1604;&#1578;&#1582;&#1589;&#1610;&#1589; &#1601;&#1589;&#1604; &#1603;&#1575;&#1605;&#1604; &#1601;&#1610; &#1571;&#1581;&#1583; &#1603;&#1578;&#1576;&#1607;&#1575; &#1575;&#1604;&#1605;&#1581;&#1603;&#1605;&#1577; &#1604;&#1604;&#1581;&#1583;&#1610;&#1579; &#1593;&#1606; &#1575;&#1604;&#1593;&#1604;&#1575;&#1602;&#1577; &#1575;&#1604;&#1593;&#1575;&#1591;&#1601;&#1610;&#1577; &#1576;&#1610;&#1606; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1608;&#1575;&#1604;&#1585;&#1608;&#1576;&#1608;&#1578;&#1548; &#1608;&#1602;&#1583; &#1602;&#1575;&#1605; &#1575;&#1604;&#1576;&#1585;&#1608;&#1601;&#1587;&#1608;&#1585; &#1571;&#1583;&#1585;&#1610;&#1575;&#1606; &#1578;&#1588;&#1610;&#1608;&#1603; (Adrian Cheok) &#1601;&#1610; &#1584;&#1604;&#1603; &#1575;&#1604;&#1603;&#1578;&#1575;&#1576; &#1576;&#1605;&#1585;&#1575;&#1580;&#1593;&#1577; &#1593;&#1583;&#1583; &#1605;&#1606; &#1575;&#1604;&#1571;&#1576;&#1581;&#1575;&#1579; &#1601;&#1610; &#1607;&#1584;&#1575; &#1575;&#1604;&#1605;&#1580;&#1575;&#1604;&#1548; &#1608;&#1582;&#1604;&#1589; &#1573;&#1604;&#1609; &#1571;&#1606; &#1575;&#1604;&#1593;&#1604;&#1575;&#1602;&#1577; &#1575;&#1604;&#1593;&#1575;&#1591;&#1601;&#1610;&#1577; &#1576;&#1610;&#1606; &#1575;&#1604;&#1573;&#1606;&#1587;&#1575;&#1606; &#1608;&#1575;&#1604;&#1585;&#1608;&#1576;&#1608;&#1578; &#1605;&#1606; &#1575;&#1604;&#1605;&#1608;&#1590;&#1608;&#1593;&#1575;&#1578; &#1575;&#1604;&#1578;&#1610; &#1605;&#1575; &#1586;&#1575;&#1604;&#1578; &#1578;&#1581;&#1578;&#1575;&#1580; &#1573;&#1604;&#1609; &#1605;&#1586;&#1610;&#1583; &#1605;&#1606; &#1575;&#1604;&#1583;&#1585;&#1575;&#1587;&#1575;&#1578; &#1608;&#1575;&#1604;&#1571;&#1576;&#1581;&#1575;&#1579;.
#&#1604;&#1605; &#1610;&#1578;&#1605;&#1603;&#1606; &#1575;&#1604;&#1576;&#1588;&#1585; &#1593;&#1576;&#1585; &#1575;&#1604;&#1593;&#1589;&#1608;&#1585; &#1605;&#1606; &#1578;&#1601;&#1587;&#1610;&#1585; &#1592;&#1575;&#1607;&#1585;&#1577; &#1575;&#1604;&#1581;&#1576; &#1593;&#1604;&#1609; &#1575;&#1604;&#1605;&#1587;&#1578;&#1608;&#1609; &#1575;&#1604;&#1591;&#1576;&#1610;&#1593;&#1610; &#1608;&#1575;&#1604;&#1605;&#1571;&#1604;&#1608;&#1601;&#1548; &#1608;&#1581;&#1610;&#1606; &#1578;&#1587;&#1578;&#1580;&#1583; &#1589;&#1608;&#1585; &#1605;&#1582;&#1578;&#1604;&#1601;&#1577; &#1604;&#1604;&#1593;&#1588;&#1602; &#1601;&#1573;&#1606; &#1578;&#1601;&#1587;&#1610;&#1585; &#1607;&#1584;&#1607; &#1575;&#1604;&#1592;&#1575;&#1607;&#1585;&#1577; &#1610;&#1586;&#1583;&#1575;&#1583; &#1578;&#1593;&#1602;&#1610;&#1583;&#1575;&#1611;. &#1601;&#1573;&#1584;&#1575; &#1603;&#1575;&#1606;&#1578; &#1575;&#1604;&#1576;&#1588;&#1585;&#1610;&#1577; &#1578;&#1602;&#1576;&#1604;&#1578; &#1601;&#1603;&#1585;&#1577; &#1575;&#1604;&#1593;&#1604;&#1575;&#1602;&#1577; &#1575;&#1604;&#1593;&#1575;&#1591;&#1601;&#1610;&#1577; &#1585;&#1594;&#1605; &#1594;&#1605;&#1608;&#1590;&#1607;&#1575;&#1548; &#1601;&#1607;&#1604; &#1587;&#1578;&#1578;&#1602;&#1576;&#1604; &#1575;&#1604;&#1576;&#1588;&#1585;&#1610;&#1577; &#1571;&#1606; &#1610;&#1593;&#1588;&#1602; &#1585;&#1608;&#1576;&#1608;&#1578;&#1575;&#1611; &#1571;&#1606;&#1587;&#1575;&#1606;.)
